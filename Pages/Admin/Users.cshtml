@page
@model HouseApp.Pages.Admin.AdminUsersModel
@{
    Layout = "/Pages/Admin/_AdminLayout.cshtml";
}

<h2 class="my-4">Manage Users</h2>

<!-- Display the User List in a Bootstrap Styled Table -->
<table class="table table-striped table-bordered table-hover">
    <thead class="thead-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Model.Users)
        {
            <tr id="user-row-@user.Id">
                <td>@user.Id</td>
                <td>@user.Name</td>
                <td>@user.Email</td>
                <td>@user.Role</td>
                <td>
                    <!-- Edit Button triggers modal -->
                    <button type="button" class="btn btn-sm btn-warning"
                            onclick="editUser('@user.Id', '@user.Name', '@user.Email', '@user.Role')">
                        Edit
                    </button>

                    <!-- Delete Button calls JS function -->
                    <button type="button" class="btn btn-sm btn-danger"
                            onclick="deleteUser(@user.Id)">
                        Delete
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm" style="background-color: #030f25;">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editUserId" />


                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editUserName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editUserName" name="name" required />

                    </div>
                    <div class="mb-3">
                        <label for="editUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editUserEmail" name="email" required />

                    </div>
                    <div class="mb-3">
                        <label for="editUserRole" class="form-label">Role</label>
                        <input type="text" class="form-control" id="editUserRole" name="role" required />

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditUser()">Save Changes</button>

                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function editUser(id, name, email, role) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserName').value = name;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function submitEditUser() {
            const formData = new FormData();
            formData.append('id', document.getElementById('editUserId').value);
            formData.append('name', document.getElementById('editUserName').value);
            formData.append('email', document.getElementById('editUserEmail').value);
            formData.append('role', document.getElementById('editUserRole').value);

            fetch('?handler=EditUser', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                        window.location.reload();
                    } else {
                        response.text().then(msg => {
                            console.error('Server error response:', msg);
                            alert('Error: ' + msg);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving changes');
                });
        }

        function deleteUser(id) {

            if (!confirm('Are you sure you want to delete this user?')) return;

            fetch(`/api/User/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    // Remove user row from table
                    const row = document.getElementById(`user-row-${id}`);
                    if (row) row.remove();
                } else {
                    response.text().then(msg => {
                        alert("Failed to delete user: " + msg);
                    });
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert("An error occurred while deleting the user.");
            });
        }
    </script>
}
